### 新增系统调用实现

**以下内容基于Ubuntu19.10 + 内核Linux5.4.21,如果是4.x.x版本的内核,参考以下下文链接**
👉[基于Linux4代内核的新增系统调用步骤](https://blog.csdn.net/qq_41175905/article/details/80529245)

**1.配置虚拟机**
[Vmware安装虚拟机Ubuntu知乎教程链接🔗](https://zhuanlan.zhihu.com/p/38797088)
[VMware虚拟机扩展Ubuntu系统磁盘空间教程🔗](https://blog.csdn.net/daemon_2017/article/details/80660372)



**2.更换Ubuntu源为清华源**
[更换镜像源链接🔗](https://blog.csdn.net/yumei1998/article/details/83214433)
注意你的Ubuntu版本,选择适配的镜像源,可加快安装包的速度.



**3.一键配置所有所需要的包**
换好镜像源后直接在命令行里配置就行了.

```
apt-get install libncurses-dev flex bison openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf
```
后续如果缺其他包就安装系统提示下载就好了



**4.内核下载**
别去www.kernel.org下了,速度实在不忍直视
直接通过下述链接下载配置.
[kernel镜像源链接🔗](http://ftp.sjtu.edu.cn/sites/ftp.kernel.org/pub/linux/kernel/)
选择合适的版本挑一个下载即可.



**5.安装内核**

- ctrl+alt+t快速打开CMD,并且输入sudo su获得管理员权限.
- 将下载好的内核move到/usr/src目录下,使用命令

```
sudo mv **/**/**/linux***  /usr/src/
//**代表你刚下载的linux内核的路径
```
- 进入/usr/src/ 解压文件

```
sudo tar -xvf  linux****
//linux***代表你刚下载的linux内核的文件名,可以用tab自动补齐.
```

- 进入解压出来的内核文件中的kernel目录

```
cd linux***/kernel
```

- 修改sys.c文件

```
sudo gedit sys.c
//在最末尾加上你想加的新的系统调用
//举个例子,helloworld程序
SYSCALL_DEFINE1(helloworld,int,number){
        printk("Hello,world!");
        return number+1
}
//对系统调用的编写 注意此处与前版本内核的不同
//上述程序中,1代表这个函数只有一个参数,有两个参数就换成2
//helloworld是新增系统调用函数名
//int是参数类型,number是形参.
//函数功能就是打印Hello,world!,并且返回1+number.可以通过dmesg看到打印的句子.
```

- 增加系统调用号

```
//从kernel返回上一级目录
cd /arch/x86/entry/syscalls
sudo gedit syscall_64.tbl
//增加一个新的系统调用
//例如 335    64  helloworld      __x64_sys_helloworld
```

- 增加系统调用头文件

```
//返回/usr/src/linux***目录
cd include/linux
sudo gedit syscalls.h
//例如asmlinkage long sys_helloworld(int number);
```
- 最后按照上述步骤编写你的文件copy和P、V操作系统调用程序吧



**6.编译内核**

```
sudo make mrproper //删除之前编译的残余文件.只在第一次编译时执行即可,以免每次编译把重复文件重复编译.
sudo make clean //可执行可不执行,因为上一个命令似乎是涵盖了clean的
sudo make menuconfig//在general setup哪里给你的内核换个名字,比如AlexKernel
sudo make -j4 //根据你给虚拟机分配的核心数来适配.我分了4核心.
sudo make modules_install // 安装内核模块
sudo make install //安装内核
```

**7.更换系统默认启动内核**
[更换启动内核链接🔗](https://blog.csdn.net/cf_wu95/article/details/85984956)



**8.重启,编写你的测试c文件.**



(PS:不嫌麻烦的可以直接看官方文档。[新增系统调用方法官方文档](https://www.kernel.org/doc/html/latest/process/adding-syscalls.html))

